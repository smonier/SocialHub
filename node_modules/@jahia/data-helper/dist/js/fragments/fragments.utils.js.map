{"version":3,"names":["_graphql","require","_fragments","_rfdc","_interopRequireDefault","ownKeys","e","r","t","Object","keys","getOwnPropertySymbols","o","filter","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","arguments","length","forEach","_defineProperty2","getOwnPropertyDescriptors","defineProperties","defineProperty","clone","rfdc","findParametersInDocument","doc","definitions","flatMap","def","findParametersInSelectionSet","selectionSet","queryCache","replaceFragmentsInDocument","fragments","key","name","value","map","f","PredefinedFragments","gql","sort","join","clonedQuery","replaceFragmentsInSelectionSet","operationDefinition","selections","sel","arg","kind","concat","findFragmentsInSelectionSet","document","_ref3","newFragmentsSpreads","removedFragmentSpreads","existing","find","definition","applyableFragments","frag","applyFor","fragment","newSpread","allVariables","reduce","result","n","variables","entries","_ref","_ref2","_slicedToArray2","variableDefinitions","variableDef","variable","type","parseType","noLocation","indexOf"],"sources":["fragments.utils.ts"],"sourcesContent":["import {\n    DefinitionNode,\n    DocumentNode,\n    FragmentSpreadNode,\n    NameNode,\n    parseType,\n    SelectionNode,\n    SelectionSetNode,\n    VariableDefinitionNode\n} from 'graphql';\nimport {Fragment, PredefinedFragments} from '../fragments';\nimport {ExecutableDefinitionNode, FragmentDefinitionNode, OperationDefinitionNode} from 'graphql/language/ast';\nimport rfdc from 'rfdc';\n\nconst clone = rfdc();\n\ntype Mutable<T> = {\n    -readonly [P in keyof T]: T[P]\n};\n\nfunction findParametersInDocument(doc: DocumentNode): string[] {\n    if (doc && doc.definitions) {\n        return doc.definitions.flatMap(def => 'selectionSet' in def ? findParametersInSelectionSet(def.selectionSet) : []);\n    }\n\n    return [];\n}\n\nconst queryCache: {[key:string]: DocumentNode} = {};\n\nfunction replaceFragmentsInDocument(doc: DocumentNode, fragments: (string|Fragment)[]) {\n    if (!fragments) {\n        fragments = [];\n    }\n\n    const key = (doc.definitions[0] as ExecutableDefinitionNode).name.value + '__' + fragments\n        .map(f => (typeof f === 'string') ? PredefinedFragments[f] : f)\n        .map(f => (f.gql.definitions[0] as FragmentDefinitionNode).name.value)\n        .sort()\n        .join('_');\n\n    if (queryCache[key]) {\n        return queryCache[key];\n    }\n\n    let clonedQuery: DocumentNode = null;\n    if (doc && doc.definitions) {\n        clonedQuery = clone(doc);\n        clonedQuery.definitions.forEach(def => 'selectionSet' in def && replaceFragmentsInSelectionSet(def.selectionSet, fragments, def, clonedQuery));\n        const operationDefinition = clonedQuery.definitions[0] as OperationDefinitionNode;\n        (operationDefinition.name as Mutable<NameNode>).value = key;\n    }\n\n    queryCache[key] = clonedQuery;\n\n    return clonedQuery;\n}\n\nfunction findParametersInSelectionSet(selectionSet: SelectionSetNode): string[] {\n    if (selectionSet && selectionSet.selections) {\n        return selectionSet.selections.flatMap(sel => {\n            if ('arguments' in sel) {\n                return sel.arguments\n                    .filter(arg => (arg.value.kind === 'Variable'))\n                    .flatMap(arg => 'name' in arg.value ? [arg.value.name.value] : [])\n                    .concat(findParametersInSelectionSet(sel.selectionSet))\n                    .filter(f => typeof f !== 'undefined');\n            }\n\n            return [];\n        });\n    }\n\n    return [];\n}\n\nfunction findFragmentsInSelectionSet(selectionSet: SelectionSetNode): string[] {\n    if (selectionSet && selectionSet.selections) {\n        return selectionSet.selections\n            .filter<FragmentSpreadNode>((sel): sel is FragmentSpreadNode => sel.kind === 'FragmentSpread').map(sel => sel.name.value)\n            .concat(selectionSet.selections.flatMap(sel => findFragmentsInSelectionSet('selectionSet' in sel && sel.selectionSet)));\n    }\n\n    return [];\n}\n\nfunction replaceFragmentsInSelectionSet(selectionSet: SelectionSetNode, fragments: (string|Fragment)[], def: ExecutableDefinitionNode, document: Mutable<DocumentNode>) {\n    if (selectionSet && selectionSet.selections) {\n        const newFragmentsSpreads: FragmentSpreadNode[] = [];\n        const removedFragmentSpreads: FragmentSpreadNode[] = [];\n        // Look for all existing fragment spreads in selection set\n        selectionSet.selections.filter<FragmentSpreadNode>((sel): sel is FragmentSpreadNode => sel.kind === 'FragmentSpread').forEach(sel => {\n            // Handle only named fragments\n            if (sel.name.value) {\n                // Check if spread exists in current doc - if not, we replace or remove it\n                const existing = document.definitions.find(definition => definition.kind === 'FragmentDefinition' && definition.name.value === sel.name.value);\n\n                if (!existing) {\n                    // First remove the spread, as it has no match in document\n                    removedFragmentSpreads.push(sel);\n\n                    // Check if a replacement is provided for this pseudo-fragment, then insert spreads and definitions\n                    if (fragments) {\n                        const applyableFragments = fragments\n                            .map(frag => (typeof frag === 'string') ? PredefinedFragments[frag] : frag)\n                            .filter(frag => frag.applyFor === sel.name.value);\n\n                        applyableFragments.flatMap((fragment:Fragment) => fragment.gql.definitions).forEach((frag: FragmentDefinitionNode) => {\n                            const newSpread = clone(sel);\n                            (newSpread.name as Mutable<NameNode>).value = (frag as FragmentDefinitionNode).name.value;\n                            newFragmentsSpreads.push(newSpread);\n\n                            // Add the new fragment definition in document if it has not already been added\n                            if (!document.definitions.find(definition => definition.kind === 'FragmentDefinition' && definition.name.value === frag.name.value)) {\n                                (document.definitions as Array<DefinitionNode>).push(frag);\n                            }\n                        });\n\n                        // Adds the associated variables to the query\n                        const allVariables = applyableFragments.reduce((result:{[key: string]:string}, n) => ({...result, ...n.variables}), {});\n                        Object.entries(allVariables).forEach(([name, value]) => {\n                            if (!def.variableDefinitions.find(variableDef => variableDef.variable.name.value === name)) {\n                                const type = parseType(value, {noLocation: true});\n                                (def.variableDefinitions as Array<VariableDefinitionNode>).push({\n                                    kind: 'VariableDefinition',\n                                    variable: {\n                                        kind: 'Variable',\n                                        name: {\n                                            kind: 'Name',\n                                            value: name\n                                        }\n                                    },\n                                    type\n                                });\n                            }\n                        });\n                    }\n                }\n            }\n        });\n\n        // Removed replaced spreads\n        selectionSet.selections = selectionSet.selections.filter(sel => sel.kind !== 'FragmentSpread' || removedFragmentSpreads.indexOf(sel) === -1);\n\n        // Add all new spreads\n        (selectionSet.selections as Array<SelectionNode>).push(...newFragmentsSpreads);\n\n        // Recursively call on sub-selections set\n        selectionSet.selections.forEach(sel => 'selectionSet' in sel && replaceFragmentsInSelectionSet(sel.selectionSet, fragments, def, document));\n    }\n}\n\nexport {replaceFragmentsInDocument, findParametersInDocument, findFragmentsInSelectionSet};\n"],"mappings":"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","ignoreList":[]}